<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ByteBite - Login</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <div class="nav-brand">
        <h1>ByteBite</h1>
        <p class="nav-subtitle">Delivery in minutes</p>
      </div>
      <div class="nav-links">
        <a class="nav-link" href="index.html">Home</a>
        <a class="nav-link" href="customer.html">Customer portal</a>
        <a class="nav-link" href="restaurant.html">Restaurant portal</a>
        <a class="nav-link active" href="login.html">Login / Sign up</a>
      </div>
    </div>
  </nav>

  <header class="page-header">
    <div class="container">
      <p class="eyebrow">Access</p>
      <h1>Sign in or create an account</h1>
      <p>One account for customers, restaurants, and drivers with role-based access.</p>
    </div>
  </header>

  <main class="container">
    <section class="form-section">
      <div class="form-container">
        <div class="toggle-row" role="tablist">
          <button id="tabLogin" class="toggle-btn active" aria-selected="true" aria-controls="loginPanel">Sign in</button>
          <button id="tabSignup" class="toggle-btn" aria-selected="false" aria-controls="signupPanel">Sign up</button>
        </div>

        <div id="loginPanel" class="auth-panel" role="tabpanel">
          <div class="section-heading">
            <p class="eyebrow">Welcome back</p>
            <h2>Enter your credentials</h2>
            <p class="section-subtitle">Email, password, and role must match your account.</p>
          </div>

          <form id="loginForm" class="form">
            <div class="form-group">
              <label for="loginEmail">Email</label>
              <input type="email" id="loginEmail" autocomplete="email" required>
            </div>

            <div class="form-group">
              <label for="loginPassword">Password</label>
              <input type="password" id="loginPassword" autocomplete="current-password" required>
            </div>

            <div class="form-group">
              <label for="loginRole">Role</label>
              <select id="loginRole" required>
                <option value="customer">Customer</option>
                <option value="restaurant">Restaurant</option>
                <option value="driver">Driver</option>
              </select>
              <small>Must match the role stored on your account.</small>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary">Sign in</button>
            </div>
          </form>

          <div id="loginSuccess" class="message message-success" style="display:none;">
            Logged in. Redirecting...
          </div>
          <div id="loginError" class="message message-error" style="display:none;">
            <span id="loginErrorText"></span>
          </div>
        </div>

        <div id="signupPanel" class="auth-panel" role="tabpanel" style="display:none;">
          <div class="section-heading">
            <p class="eyebrow">Create account</p>
            <h2>Join ByteBite</h2>
            <p class="section-subtitle">We create your account and return a session token on success.</p>
          </div>

          <form id="signupForm" class="form">
            <div class="form-group">
              <label for="signupName">Full name</label>
              <input type="text" id="signupName" autocomplete="name" required>
            </div>

            <div class="form-group">
              <label for="signupEmail">Email</label>
              <input type="email" id="signupEmail" autocomplete="email" required>
            </div>

            <div class="form-group">
              <label for="signupPhone">Phone</label>
              <input type="tel" id="signupPhone" autocomplete="tel" placeholder="Optional">
            </div>

            <div class="form-group">
              <label for="signupPassword">Password</label>
              <input type="password" id="signupPassword" autocomplete="new-password" required>
            </div>

            <div class="form-group">
              <label for="signupRole">Role</label>
              <select id="signupRole" required>
                <option value="customer">Customer</option>
                <option value="restaurant">Restaurant</option>
                <option value="driver">Driver</option>
              </select>
              <small>Choose the role you will use to sign in.</small>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary">Create account</button>
            </div>
          </form>

          <div id="signupSuccess" class="message message-success" style="display:none;">
            Account created. Redirecting...
          </div>
          <div id="signupError" class="message message-error" style="display:none;">
            <span id="signupErrorText"></span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <p>Cloud Computing Project · IE University · Fall 2025</p>
  </footer>

  <script>
    // Use production API (local functions need additional setup)
    // To use local: change to 'http://localhost:7071/api'
    const API_BASE_URL = 'https://bytebite-functions-g6gng2eahnb0f2gw.westeurope-01.azurewebsites.net/api';
    const LOGIN_ENDPOINT = `${API_BASE_URL}/login`;
    const SIGNUP_ENDPOINT = `${API_BASE_URL}/signup`;

    const tabLogin = document.getElementById('tabLogin');
    const tabSignup = document.getElementById('tabSignup');
    const loginPanel = document.getElementById('loginPanel');
    const signupPanel = document.getElementById('signupPanel');

    const loginForm = document.getElementById('loginForm');
    const loginSuccess = document.getElementById('loginSuccess');
    const loginError = document.getElementById('loginError');
    const loginErrorText = document.getElementById('loginErrorText');

    const signupForm = document.getElementById('signupForm');
    const signupSuccess = document.getElementById('signupSuccess');
    const signupError = document.getElementById('signupError');
    const signupErrorText = document.getElementById('signupErrorText');

    function setTab(isLogin) {
      if (isLogin) {
        tabLogin.classList.add('active');
        tabSignup.classList.remove('active');
        tabLogin.setAttribute('aria-selected', 'true');
        tabSignup.setAttribute('aria-selected', 'false');
        loginPanel.style.display = 'block';
        signupPanel.style.display = 'none';
      } else {
        tabSignup.classList.add('active');
        tabLogin.classList.remove('active');
        tabSignup.setAttribute('aria-selected', 'true');
        tabLogin.setAttribute('aria-selected', 'false');
        signupPanel.style.display = 'block';
        loginPanel.style.display = 'none';
      }
    }

    tabLogin.addEventListener('click', () => setTab(true));
    tabSignup.addEventListener('click', () => setTab(false));

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginSuccess.style.display = 'none';
      loginError.style.display = 'none';

      const payload = {
        email: document.getElementById('loginEmail').value.trim().toLowerCase(),
        password: document.getElementById('loginPassword').value,
        role: document.getElementById('loginRole').value
      };

      try {
        console.log('Calling login endpoint:', LOGIN_ENDPOINT);
        
        let response;
        try {
          response = await fetch(LOGIN_ENDPOINT, {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(payload),
            mode: 'cors',
            credentials: 'omit',
            cache: 'no-cache'
          });
        } catch (fetchError) {
          console.error('Fetch error, trying XMLHttpRequest fallback...');
          return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', LOGIN_ENDPOINT, true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.setRequestHeader('Accept', 'application/json');
            
            xhr.onload = function() {
              if (xhr.status >= 200 && xhr.status < 300) {
                try {
                  const result = JSON.parse(xhr.responseText);
                  localStorage.setItem('bytebite_token', result.token);
                  localStorage.setItem('bytebite_role', result.role);
                  localStorage.setItem('bytebite_name', result.name || '');
                  loginSuccess.style.display = 'block';
                  setTimeout(() => {
                    window.location.href = result.role === 'driver' ? 'driver.html' : result.role === 'restaurant' ? 'restaurant.html' : 'customer.html';
                  }, 900);
                  resolve();
                } catch (e) {
                  reject(new Error('Invalid response from server'));
                }
              } else {
                try {
                  const errorData = JSON.parse(xhr.responseText);
                  reject(new Error(errorData.error || `Server error: ${xhr.status}`));
                } catch (e) {
                  reject(new Error(`Server error: ${xhr.status} ${xhr.statusText}`));
                }
              }
            };
            
            xhr.onerror = function() {
              reject(new Error('Network error: Cannot connect to server. Check your connection and try again.'));
            };
            
            xhr.send(JSON.stringify(payload));
          });
        }

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: `HTTP ${response.status}: ${response.statusText}` }));
          throw new Error(errorData.error || `Server error: ${response.status}`);
        }

        const result = await response.json();
        console.log('Login success:', result);

        localStorage.setItem('bytebite_token', result.token);
        localStorage.setItem('bytebite_role', result.role);
        localStorage.setItem('bytebite_name', result.name || '');

        loginSuccess.style.display = 'block';
        setTimeout(() => {
          window.location.href = result.role === 'driver' ? 'driver.html' : result.role === 'restaurant' ? 'restaurant.html' : 'customer.html';
        }, 900);
      } catch (err) {
        console.error('Login error:', err);
        const errorMsg = err.message || 'Failed to login. Please check your connection and try again.';
        loginErrorText.textContent = errorMsg;
        loginError.style.display = 'block';
      }
    });

    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      signupSuccess.style.display = 'none';
      signupError.style.display = 'none';

      const payload = {
        name: document.getElementById('signupName').value.trim(),
        email: document.getElementById('signupEmail').value.trim().toLowerCase(),
        phone: document.getElementById('signupPhone').value.trim(),
        password: document.getElementById('signupPassword').value,
        role: document.getElementById('signupRole').value
      };

      try {
        console.log('Calling signup endpoint:', SIGNUP_ENDPOINT);
        console.log('Payload:', { ...payload, password: '***' });
        
        let response;
        try {
          response = await fetch(SIGNUP_ENDPOINT, {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(payload),
            mode: 'cors',
            credentials: 'omit',
            cache: 'no-cache'
          });
        } catch (fetchError) {
          console.error('Fetch error details:', fetchError);
          console.error('Error name:', fetchError.name);
          console.error('Error message:', fetchError.message);
          
          // Try XMLHttpRequest as fallback
          console.log('Trying XMLHttpRequest fallback...');
          return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', SIGNUP_ENDPOINT, true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.setRequestHeader('Accept', 'application/json');
            
            xhr.onload = function() {
              if (xhr.status >= 200 && xhr.status < 300) {
                try {
                  const result = JSON.parse(xhr.responseText);
                  console.log('Signup success (XHR):', result);
                  localStorage.setItem('bytebite_token', result.token);
                  localStorage.setItem('bytebite_role', result.role);
                  localStorage.setItem('bytebite_name', result.name || payload.name);
                  signupSuccess.style.display = 'block';
                  setTimeout(() => {
                    window.location.href = result.role === 'driver' ? 'driver.html' : result.role === 'restaurant' ? 'restaurant.html' : 'customer.html';
                  }, 900);
                  resolve();
                } catch (e) {
                  reject(new Error('Invalid response from server'));
                }
              } else {
                try {
                  const errorData = JSON.parse(xhr.responseText);
                  reject(new Error(errorData.error || `Server error: ${xhr.status}`));
                } catch (e) {
                  reject(new Error(`Server error: ${xhr.status} ${xhr.statusText}`));
                }
              }
            };
            
            xhr.onerror = function() {
              reject(new Error('Network error: Cannot connect to server. Check your connection and try again.'));
            };
            
            xhr.send(JSON.stringify(payload));
          });
        }

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: `HTTP ${response.status}: ${response.statusText}` }));
          throw new Error(errorData.error || `Server error: ${response.status}`);
        }

        const result = await response.json();
        console.log('Signup success:', result);

        localStorage.setItem('bytebite_token', result.token);
        localStorage.setItem('bytebite_role', result.role);
        localStorage.setItem('bytebite_name', result.name || payload.name);

        signupSuccess.style.display = 'block';
        setTimeout(() => {
          window.location.href = result.role === 'driver' ? 'driver.html' : result.role === 'restaurant' ? 'restaurant.html' : 'customer.html';
        }, 900);
      } catch (err) {
        console.error('Signup error:', err);
        const errorMsg = err.message || 'Failed to create account. Please check your connection and try again.';
        signupErrorText.textContent = errorMsg;
        signupError.style.display = 'block';
      }
    });
  </script>
</body>
</html>
